# docker-compose.amphigory.yaml
# Docker Compose configuration for Amphigory
#
# To integrate with existing beehive-docker setup:
# Option 1: Copy service definition to /opt/beehive-docker/docker-compose.yaml
# Option 2: Run standalone: docker-compose -f docker-compose.amphigory.yaml up -d

services:
  amphigory:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: amphigory
    restart: unless-stopped
    ports:
      - "6199:6199"
    environment:
      # Timezone
      - TZ=America/Los_Angeles

      # Application paths
      - AMPHIGORY_DATA=/data
      - AMPHIGORY_CONFIG=/config
      - AMPHIGORY_RIPPED_DIR=/media/ripped
      - AMPHIGORY_TRANSCODED_DIR=/media/transcoded
      - AMPHIGORY_PLEX_DIR=/media/plex/data
      - AMPHIGORY_WIKI_DIR=/wiki

      # MakeMKV license key (required for Blu-ray support after trial period)
      # Set this in a .env file or pass via command line
      - MAKEMKV_KEY=${MAKEMKV_KEY:-}

      # TMDB API key for movie metadata lookup
      - TMDB_API_KEY=${TMDB_API_KEY:-}

      # Path where daemon should write ripped files (host path, not container path)
      # This is passed to the daemon via task files
      - DAEMON_RIPPED_DIR=/Volumes/Media Drive 1/Amphigory Media/ripped

    volumes:
      # Application data (database, etc.)
      - /opt/beehive-docker/amphigory/data:/data
      # Note: /config is baked into the image with presets and logging config.
      # To use custom presets, uncomment the line below:
      # - /opt/beehive-docker/amphigory/config:/config

      # Media directories
      - /Volumes/Media Drive 1/Amphigory Media:/media
      - /Volumes/Media Drive 1/plex-media-server/data:/media/plex/data

      # Wiki integration for Gollum
      - /opt/beehive-docker/gollum/wiki-data:/wiki

    # Note: Optical drive access is handled by the native macOS daemon,
    # not the container. The daemon rips to shared storage, then the
    # container's HandBrakeCLI transcodes the files.

    # Optional: limit resources
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G
    #     reservations:
    #       cpus: '2'
    #       memory: 4G

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6199/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
